<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
	<link href="static/bootstrap-3.2.0-dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="static/bootstrap-3.2.0-dist/css/custom.css" rel="stylesheet">
	<link href="static/style.css" rel="stylesheet" type="text/css" />
	<script type="text/javascript" src="static/js/jquery-1.7.1.min.js"></script> 
    <script type="text/javascript" src="static/js/jquery.form.js"></script>
    <script type="text/javascript" src="static/js/jquery.autoresize.js"></script>
    <script type="text/javascript" src="static/js/jquery.bpopup.min.js"></script>

	
	<script type="text/javascript">

		function ffmp3Callback(event,value){
    		//alert('event: "'+event+'", value: "'+value+'"');
		}
	
		function disableLikeButtons() {
			$('#unlike-button').removeAttr('onClick', '');
 			$('#unlike-button').removeAttr('href', '');
    		$('#like-button').removeAttr('onClick', '');
 			$('#like-button').removeAttr('href', '');
		}
		
		function enableLikeButtons() {
			$('#unlike-button').attr('onClick', 'unlike();');
 			$('#unlike-button').attr('href', 'javascript:void(0)');
    		$('#like-button').attr('onClick', 'like();');
 			$('#like-button').attr('href', 'javascript:void(0)');
 			
 			$('#unlike-button-img').attr('src', 'static/img/dislike_48.png');
 			$('#like-button-img').attr('src', 'static/img/like_48.png');
		}
		
		function unlike() {
 			disableLikeButtons()
			$('#unlike-button-img').attr('src', 'static/img/dislike_d_48.png');
			$.ajax({
  				url: "/unlike",
 				success: function(jqXHR){
 					var data = jQuery.parseJSON(jqXHR);
 					updateSatisfactionSmiley(data.satisfaction)
    				$('#unlike-button-img').attr('src', 'static/img/dislike_red_48.png');
  				}
			});
		}
	
		function like() {
			$('#like-button-img').attr('src', 'static/img/like_d_48.png');
    		disableLikeButtons()
			$.ajax({
  				url: "/like",
 				success: function(jqXHR){
 					var data = jQuery.parseJSON(jqXHR);
 					updateSatisfactionSmiley(data.satisfaction)
    				$('#like-button-img').attr('src', 'static/img/like_green_48.png');
  				}
			});
		}
		

		function selectSong() {
			selectedIndex =  document.getElementById("results-list").selectedIndex
			$.ajax({
  				url: "/perform_vote",
  				contentType: "application/json; charset=utf-8",
  				type: "POST",
  				dataType: "json",
  				data: JSON.stringify({'index': selectedIndex}, null, '\t'),
 				success: function(data){
 					updateApplicantsTable(data["applicant_songs"])
  				}
			});

			$("#results-form").bPopup().close();
		}

		function updateSatisfactionSmiley(satisfaction) {
		
			var iconUrlIdx;
			
			if (satisfaction < 0.3) {
				iconUrlIdx = "0"
			} else if (satisfaction < 0.4) {
				iconUrlIdx = "1"
			} else if (satisfaction < 0.5) {
				iconUrlIdx = "2"
			} else if (satisfaction == 0.5) {
				iconUrlIdx = "3"
			} else if (satisfaction < 0.65) {
				iconUrlIdx = "4"
			} else if (satisfaction < 0.8) {
				iconUrlIdx = "5"
			} else {
			    iconUrlIdx = "6"
			}
			
			$('#player-smiley-img').attr('src', 'static/img/s_' + iconUrlIdx + '_48.png');
		}
		
		function updateCurrentSong(song) {
			$('#current-song').html(song);
		}

		function updateApplicantsTable(list) {
			console.log(list[0])
			table2 = $(".applicants_table")
			table2.html("")
			for (var i = 0; i < list.length; i++) {
				table2.html(table2.html() + "<a style='font-size: 15px;' href='#'' class='list-group-item " + getMarkCss(i) + "'>" + list[i]  +  "<div style='margin-left:20px;''></div><input type='image' value='Vote DOWN' class='song_entry down entry-" + i + " btn btn-danger' src='static/img/thumb-down-icon.png' style='width:40px; height: 30px;margin-top:5px;''></td><td width='10px'><input type='image' class='song_entry up entry-" + i + " btn btn-success' src='static/img/thumb-up-icon.png' style='margin-left:5px; margin-top:5px; width:40px; height: 30px'></td></tr><tr>" + "</a>" )

			}
		}

		function getMarkCss(i) {
			if (i == 0) {
				return "active"
			}

			return ""
		}
	
		$(document).ready(function() {

			$(".song_entry").live("click", function (e) {
				vote_index = $(this).attr('class').split(" ")[2].split("-")[1]
				vote_type = $(this).attr('class').split(" ")[1]
			    $.ajax({
  				url: "/vote_song",
  				contentType: "application/json; charset=utf-8",
  				type: "POST",
  				dataType: "json",
  				data: JSON.stringify({'vote_index': vote_index, 'vote_type' : vote_type}, null, '\t'),
 				success: function(jqXHR){
  				}
			});
			});
		
			var options = { 
    			success: function(data) {
    				json = jQuery.parseJSON(data)
        			//alert("A Rádio LSD agradece sua sugestão!");
                	$('#form-submit').removeAttr('disabled');
                	$('#vote-form-inner').clearForm();

                	$('#result1').html(json["data"]["items"][0]["title"]);
                	$('#result2').html(json["data"]["items"][1]["title"]);
                	$('#result3').html(json["data"]["items"][2]["title"]);
                	$('#result4').html(json["data"]["items"][3]["title"]);
                	$('#result5').html(json["data"]["items"][4]["title"]);
                	$('#result6').html(json["data"]["items"][5]["title"]);
                	$('#result7').html(json["data"]["items"][6]["title"]);
                	$('#result8').html(json["data"]["items"][7]["title"]);
                	$('#result9').html(json["data"]["items"][8]["title"]);
                	$('#result10').html(json["data"]["items"][9]["title"]);

                	$("#results-form").bPopup();

    			},
    			
    			error: function() { 
        			alert("Sugestão não computada por problemas técnicos :(");
                	$('#form-submit').removeAttr('disabled');
                	$('#vote-form-inner').clearForm();
    			},
    			
    			beforeSubmit: function() { 
        			$('#form-submit').attr('disabled','disabled'); 
    			}
			};
			
            // bind 'myForm' and provide a simple callback function 
            $('#vote-form-inner').ajaxForm(options);
           	
           	var updater = new Worker('static/js/updater.js');
           	updater.onmessage = function (event) {
     			var data = jQuery.parseJSON(event.data);
     			if (data.vote == 'none') {
     				enableLikeButtons()
     			}
     			updateSatisfactionSmiley(data.satisfaction);
     			updateCurrentSong(data.current_song);
     			updateApplicantsTable(data.applicant_songs);
   			};
   			
   			$('#vote-textarea').autoResize({
    			maxHeight: 200,
    			minHeight: 50
			});
           	
        });
        
	</script>
	
	<title>LSD Radio - Fazendo sua cabeça</title>

	
</head>

<body style="font-family: Trebuchet MS; background-image: url('static/img/background.jpg');background-size: 100% 100%;";>

	<!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

            	<div>
            		<img src="static/img/playing.png" style="float:left;margin-right:5px;margin-top:7px;">
                	<a class="navbar-brand" style:"font-weight:bold; color:white !important;">Ouvindo agora:</a>
                	<a class="navbar-brand" id="current-song">Start Bootstrap</a>
                </div>

            </div>

            <div id="player" style="visibility:hidden;">
			<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" bgcolor="#FFFFFF">
				<param name="movie" value="static/ffmp3.swf" />
				<param name="flashvars" value="url=http://{{server_url}}/ices&lang=en&codec=mp3&volume=100&traking=true&jsevents=true&autoplay=true&buffering=5&title=LSD+Radio" />
				<param name="wmode" value="window" />
				<param name="allowscriptaccess" value="always" />
				<param name="scale" value="noscale" />
				<embed src="static/ffmp3.swf" flashvars="url=http://{{server_url}}/ices&lang=en&codec=mp3&volume=100&traking=true&jsevents=true&autoplay=true&buffering=5&title=LSD+Radio" width="329" scale="noscale" height="21" wmode="window" bgcolor="#FFFFFF" allowscriptaccess="always" type="application/x-shockwave-flash" />
			</object>
			</div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <!--div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="hidden">
                        <a href="#page-top"></a>
                    </li>
                    <li class="page-scroll">
                        <a href="#portfolio">Portfolio</a>
                    </li>
                    <li class="page-scroll">
                        <a href="#about">About</a>
                    </li>
                    <li class="page-scroll">
                        <a href="#contact">Contact</a>
                    </li>
                </ul>
            </div-->
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>

	<div id="main" class="container cleafix">
	
	<label style="font-size: 40px; font-weight: bold; margin-top: 20px">Dê sua opinião sobre a música atual!</label>
		<div id="player-toolbar" class="clearfix">
			<ul>
				
				<li><a id="unlike-button" {% if vote == 'none' %} href="javascript:void(0)" onClick="unlike();" {% endif %}>
					<img id="unlike-button-img" src="static/img/dislike_{% if vote == 'unlike' %}red_{% endif %}48.png">
				</a></li>
				
				<li><img id="player-smiley-img" src="static/img/s_3_48.png"></li>
				
				<li><a id="like-button" {% if vote == 'none' %} href="javascript:void(0)" onClick="like();" {% endif %}>
					<img id="like-button-img" src="static/img/like_{% if vote == 'like' %}green_{% endif %}48.png">
				</a></li>
				
			</ul>
		</div>



		<center style="margin-top: 50px">
			<label style="font-size: 40px; font-weight: bold; margin-top: 20px">Vote na próxima música!</label>
			<div class="list-group applicants_table">

			</div>
		</center>
	
		<div id="vote-form" class="clearfix">
		<form id="vote-form-inner" action="busca_resultados" method="post">
			<textarea rows="1" cols="50" name="vote" id="vote-textarea" class="form-control" placeholder="Sugira uma música!"></textarea>
			<button type="submit" id="form-submit" class="btn btn-large btn-primary">Pesquisar</button>
		</form>
		</div>
	</div>
	
	<div id="results-form" style="display:none;" class="row">
	 <select id="results-list"size="10" class="form-control">
        <option value="0" id="result1">Test 0</option>
        <option value="1" id="result2">Test 1</option>
        <option value="2" id="result3">Test 2</option>
        <option value="2" id="result4">Test 2</option>
        <option value="2" id="result5">Test 2</option>
        <option value="2" id="result6">Test 2</option>
        <option value="2" id="result7">Test 2</option>
        <option value="2" id="result8">Test 2</option>
        <option value="2" id="result9">Test 2</option>
        <option value="2" id="result10">Test 2</option>
      </select>
      <br>
      <center><input type="submit" value="Enviar Música Selecionada" onclick="selectSong()" class="btn btn-large btn-primary" style="margin-top: 10px"></center>
      </div>
</body>

<div>
	
</html>